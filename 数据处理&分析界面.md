1. æ•°æ®å¤„ç†ç•Œé¢
```
import sys
import os
import time
import traceback
from pathlib import Path
from datetime import datetime

import polars as pl
import polars.selectors as cs
from PySide6.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, 
                               QHBoxLayout, QPushButton, QFileDialog, QTableWidget, 
                               QTableWidgetItem, QSplitter, QPlainTextEdit, QLabel, 
                               QMessageBox, QHeaderView, QCheckBox, QDialog, QGroupBox,
                               QListWidget, QListWidgetItem, QProgressBar)
from PySide6.QtCore import Qt, QThread, Signal, QObject

# é…ç½® Polars æ˜¾ç¤ºé€‰é¡¹
pl.Config.set_fmt_str_lengths(50)

class DataLoader(QThread):
    """å¤šçº¿ç¨‹åŠ è½½Excelæ–‡ä»¶ï¼Œé¿å…ç•Œé¢å¡é¡¿"""
    progress = Signal(str)  # å‘é€æ—¥å¿—
    finished_one = Signal(str, object, tuple) # æ–‡ä»¶å, DataFrame, åŸå§‹shape
    all_finished = Signal()

    def __init__(self, file_paths):
        super().__init__()
        self.file_paths = file_paths

    def run(self):
        for path in self.file_paths:
            try:
                p = Path(path)
                filename = p.stem
                self.progress.emit(f"æ­£åœ¨è¯»å–: {filename} ...")
                
                # ä½¿ç”¨ calamine å¼•æ“æé€Ÿè¯»å–
                # read_csv_options ç”¨äºCSVï¼ŒExceléœ€é€šè¿‡ cast è½¬æ¢ä¸ºæ–‡æœ¬
                df = pl.read_excel(source=path, sheet_id=1, engine="calamine") # è¯»å–ç¬¬ä¸€ä¸ªè¡¨
                
                # éœ€æ±‚ï¼šè¯»å–æ¯åˆ—æ•°æ®ç±»å‹ä¸ºæ–‡æœ¬ (String)
                df = df.select(pl.all().cast(pl.String))
                
                original_shape = df.shape
                self.finished_one.emit(filename, df, original_shape)
                
            except Exception as e:
                self.progress.emit(f"è¯»å–å¤±è´¥ {path}: {str(e)}")
        
        self.all_finished.emit()

class ExportWorker(QThread):
    """åå°å¯¼å‡ºçº¿ç¨‹ï¼Œé˜²æ­¢ç•Œé¢å¡æ­»"""
    progress = Signal(str)       # å‘é€å½“å‰æ­£åœ¨å¯¼å‡ºçš„æ–‡ä»¶å
    finished_one = Signal(str)   # å•ä¸ªå®Œæˆä¿¡å·
    error_occurred = Signal(str) # é”™è¯¯ä¿¡å·
    all_finished = Signal()      # å…¨éƒ¨å®Œæˆä¿¡å·

    def __init__(self, tasks):
        """
        tasks: list of tuples (filename, dataframe, save_path)
        """
        super().__init__()
        self.tasks = tasks

    def run(self):
        for filename, df, save_path in self.tasks:
            try:
                self.progress.emit(f"æ­£åœ¨å¯¼å‡º: {filename} ...")
                # è€—æ—¶æ“ä½œï¼šå†™ Excel
                df.write_excel(save_path)
                self.finished_one.emit(f"æˆåŠŸå¯¼å‡º: {save_path}")
            except Exception as e:
                self.error_occurred.emit(f"å¯¼å‡ºå¤±è´¥ {filename}: {str(e)}")
        
        self.all_finished.emit()


from PySide6.QtGui import QColor, QBrush # éœ€è¦é¢å¤–å¼•å…¥ QColor

class DuplicateCheckDialog(QDialog):
    """é‡å¤æ•°æ®æ£€æŸ¥çª—å£ (ä¼˜åŒ–ç‰ˆï¼šè‡ªåŠ¨åˆ†ç»„æ’åº + é«˜äº®æ˜¾ç¤º)"""
    def __init__(self, df: pl.DataFrame, parent=None):
        super().__init__(parent)
        self.df = df
        self.result_df = None
        self.setWindowTitle("é‡å¤æ•°æ®æ£€æŸ¥ä¸å¤„ç†")
        self.resize(1000, 700) # ç¨å¾®è°ƒå¤§ä¸€ç‚¹ä»¥ä¾¿è§‚å¯Ÿ
        self.setup_ui()

    def setup_ui(self):
        layout = QVBoxLayout(self)

        # 1. åˆ—é€‰æ‹©
        col_group = QGroupBox("1. é€‰æ‹©æ£€æŸ¥é‡å¤çš„åˆ— (å¤šé€‰)")
        col_layout = QHBoxLayout()
        self.col_list = QListWidget()
        self.col_list.setSelectionMode(QListWidget.MultiSelection)
        self.col_list.addItems(self.df.columns)
        col_layout.addWidget(self.col_list)
        
        check_btn = QPushButton("æ£€æŸ¥å¹¶é¢„è§ˆ")
        check_btn.clicked.connect(self.check_duplicates)
        check_btn.setStyleSheet("font-weight: bold; background-color: #e1f5fe;")
        col_layout.addWidget(check_btn)
        col_group.setLayout(col_layout)
        layout.addWidget(col_group)

        # 2. é‡å¤æ•°æ®æ˜¾ç¤ºåŒº
        self.table = QTableWidget()
        layout.addWidget(QLabel("é‡å¤æ•°æ®é¢„è§ˆ (å·²æŒ‰é‡å¤é¡¹æ’åºï¼Œä¸åŒç»„ä½¿ç”¨ä¸åŒé¢œè‰²åŒºåˆ†):"))
        layout.addWidget(self.table)

        # 3. æ“ä½œåŒº
        action_group = QGroupBox("æ“ä½œ")
        action_layout = QHBoxLayout()
        
        self.keep_first_btn = QPushButton("ä¿ç•™ç¬¬ä¸€æ¡ (è‡ªåŠ¨)")
        self.keep_first_btn.clicked.connect(lambda: self.apply_dedup("first"))
        
        self.keep_last_btn = QPushButton("ä¿ç•™æœ€åä¸€æ¡ (è‡ªåŠ¨)")
        self.keep_last_btn.clicked.connect(lambda: self.apply_dedup("last"))
        
        action_layout.addWidget(self.keep_first_btn)
        action_layout.addWidget(self.keep_last_btn)
        action_group.setLayout(action_layout)
        layout.addWidget(action_group)

    def check_duplicates(self):
        selected_items = self.col_list.selectedItems()
        if not selected_items:
            QMessageBox.warning(self, "æç¤º", "è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€åˆ—")
            return
        
        # è·å–ç”¨æˆ·é€‰æ‹©çš„æŸ¥é‡ä¾æ®åˆ—
        self.subset = [item.text() for item in selected_items]
        
        # 1. æŸ¥æ‰¾é‡å¤é¡¹çš„æ©ç 
        mask = self.df.select(pl.col(self.subset)).is_duplicated()
        
        # 2. ç­›é€‰å‡ºé‡å¤æ•°æ®ï¼Œå¹¶ç«‹å³æŒ‰è¿™äº›åˆ—æ’åºï¼
        # æ’åºæ˜¯å®ç°â€œæ”¾åœ¨ä¸€èµ·â€çš„å…³é”®
        dup_df = self.df.filter(mask).sort(self.subset)
        
        row_count = dup_df.shape[0]
        if row_count == 0:
            QMessageBox.information(self, "ç»“æœ", "æœªå‘ç°é‡å¤æ•°æ®")
            self.table.setRowCount(0)
            return
            
        QMessageBox.information(self, "ç»“æœ", f"å‘ç° {row_count} æ¡é‡å¤è®°å½•\nåˆ—è¡¨å°†æ˜¾ç¤ºå‰ 1000 æ¡ä¾›é¢„è§ˆ")
        
        # 3. è®¾ç½®æ˜¾ç¤ºä¸Šé™ï¼Œé¿å…æ¸²æŸ“è¿‡å¤šå¡é¡¿
        display_limit = min(1000, row_count)
        display_df = dup_df.head(display_limit)
        
        self.table.setRowCount(display_limit)
        self.table.setColumnCount(display_df.width)
        self.table.setHorizontalHeaderLabels(display_df.columns)
        
        # å®šä¹‰ä¸€ç»„æŸ”å’Œçš„èƒŒæ™¯è‰²ç”¨äºäº¤æ›¿æ˜¾ç¤º
        # æ·¡è“, æ·¡ç»¿, æ·¡æ©™, æ·¡ç´«
        bg_colors = [
            QColor("#E3F2FD"), 
            QColor("#E8F5E9"), 
            QColor("#FFF3E0"), 
            QColor("#F3E5F5")
        ]
        color_idx = 0
        
        # ç”¨äºè®°å½•ä¸Šä¸€è¡Œçš„å…³é”®å€¼ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦åˆ‡æ¢é¢œè‰²
        prev_key_values = None 
        
        # 4. éå†å¹¶å¡«å……è¡¨æ ¼
        # å°† polars æ•°æ®è½¬ä¸º Python åˆ—è¡¨å¤„ç†ï¼Œä»¥ä¾¿äºæ¯”è¾ƒ tuple
        # è·å–ç”¨äºåˆ¤æ–­é‡å¤çš„å­é›†æ•°æ®
        subset_data = display_df.select(self.subset).rows()
        
        for r in range(display_limit):
            # è·å–å½“å‰è¡Œçš„å…³é”®å€¼ (å³æŸ¥é‡ä¾æ®çš„é‚£äº›åˆ—çš„å€¼)
            current_key_values = subset_data[r] # è¿™æ˜¯ä¸€ä¸ª tuple
            
            # å¦‚æœä¸æ˜¯ç¬¬ä¸€è¡Œï¼Œä¸”å½“å‰è¡Œçš„å…³é”®å€¼ä¸ä¸Šä¸€è¡Œä¸åŒï¼Œè¯´æ˜è¿›å…¥äº†æ–°çš„ä¸€ç»„
            if r > 0 and current_key_values != prev_key_values:
                color_idx = (color_idx + 1) % len(bg_colors) # åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé¢œè‰²
            
            current_color = bg_colors[color_idx]
            prev_key_values = current_key_values
            
            # å¡«å……è¯¥è¡Œçš„æ‰€æœ‰åˆ—
            for c, col_name in enumerate(display_df.columns):
                # è·å–å•å…ƒæ ¼æ•°æ®
                val = str(display_df[r, col_name])
                item = QTableWidgetItem(val)
                # è®¾ç½®èƒŒæ™¯è‰²
                item.setBackground(current_color)
                # è®¾ç½®åªè¯»ï¼Œé˜²æ­¢è¯¯è§¦
                item.setFlags(item.flags() ^ Qt.ItemIsEditable) 
                self.table.setItem(r, c, item)

    def apply_dedup(self, strategy):
        if not hasattr(self, 'subset'):
            QMessageBox.warning(self, "é”™è¯¯", "è¯·å…ˆæ‰§è¡Œæ£€æŸ¥")
            return
            
        # ä½¿ç”¨ Polars çš„ unique åŠŸèƒ½è¿›è¡Œå®é™…å»é‡
        self.result_df = self.df.unique(subset=self.subset, keep=strategy)
        self.accept()

import io
import matplotlib
matplotlib.use('QtAgg') # æŒ‡å®šåç«¯
from matplotlib.backends.backend_qtagg import FigureCanvasQTAgg as FigureCanvas
from matplotlib.figure import Figure
import matplotlib.pyplot as plt
from PySide6.QtGui import QImage, QPixmap, QClipboard

# é…ç½®å­—ä½“ä»¥æ”¯æŒä¸­æ–‡ (æŒ‰ä¼˜å…ˆçº§å°è¯•)
plt.rcParams['font.sans-serif'] = ['Microsoft YaHei', 'SimHei', 'Arial Unicode MS', 'sans-serif']
plt.rcParams['axes.unicode_minus'] = False # è§£å†³è´Ÿå·æ˜¾ç¤ºé—®é¢˜

class DataDistributionDialog(QDialog):
    """æ•°æ®åˆ†å¸ƒé¢„è§ˆçª—å£"""
    def __init__(self, df: pl.DataFrame, filename: str, parent=None):
        super().__init__(parent)
        self.df = df
        self.filename = filename
        self.setWindowTitle(f"æ•°æ®åˆ†å¸ƒé¢„è§ˆ - {filename}")
        self.resize(1200, 800)
        self.setup_ui()

    def setup_ui(self):
        layout = QHBoxLayout(self)

        # === å·¦ä¾§ï¼šè®¾ç½®é¢æ¿ ===
        settings_panel = QWidget()
        settings_panel.setFixedWidth(300)
        settings_layout = QVBoxLayout(settings_panel)

        # 1. é€‰æ‹©åˆ†æåˆ— (æ•°å€¼/æ–‡æœ¬åˆ—)
        settings_layout.addWidget(QLabel("<b>1. é€‰æ‹©åˆ†æåˆ—(Yè½´/ç»Ÿè®¡å¯¹è±¡):</b>"))
        self.combo_col = QComboBox()
        self.combo_col.addItems(self.df.columns)
        settings_layout.addWidget(self.combo_col)

        # 2. è§£ææ–¹å¼
        settings_layout.addWidget(QLabel("<b>2. è¯¥åˆ—è§£æä¸º:</b>"))
        self.bg_dtype = QButtonGroup(self)
        self.rb_float = QRadioButton("å°æ•° (Float)")
        self.rb_int = QRadioButton("æ•´æ•° (Int)")
        self.rb_text = QRadioButton("æ–‡æœ¬ (String)")
        self.rb_float.setChecked(True) # é»˜è®¤å°æ•°
        self.bg_dtype.addButton(self.rb_float)
        self.bg_dtype.addButton(self.rb_int)
        self.bg_dtype.addButton(self.rb_text)
        
        dtype_layout = QVBoxLayout()
        dtype_layout.addWidget(self.rb_float)
        dtype_layout.addWidget(self.rb_int)
        dtype_layout.addWidget(self.rb_text)
        settings_layout.addLayout(dtype_layout)

        # 3. ç©ºå€¼å¤„ç†
        settings_layout.addWidget(QLabel("<b>3. ç©ºå€¼/æ— æ•ˆå€¼å¤„ç†:</b>"))
        self.bg_null = QButtonGroup(self)
        self.rb_drop = QRadioButton("è·³è¿‡ (Drop)")
        self.rb_fill = QRadioButton("å¡«å……0æˆ–ç©ºæ–‡æœ¬ (Fill)")
        self.rb_drop.setChecked(True)
        self.bg_null.addButton(self.rb_drop)
        self.bg_null.addButton(self.rb_fill)
        
        null_layout = QHBoxLayout()
        null_layout.addWidget(self.rb_drop)
        null_layout.addWidget(self.rb_fill)
        settings_layout.addLayout(null_layout)

        # 4. ç»´åº¦åˆ†ç»„ (å¤šé€‰)
        settings_layout.addWidget(QLabel("<b>4. åˆ†ç»„ç»´åº¦æ ‡ç­¾ (å¤šé€‰):</b>"))
        settings_layout.addWidget(QLabel("(ä¸é€‰åˆ™åªæœ‰1å¼ æ€»åˆ†å¸ƒå›¾)"))
        self.list_dims = QListWidget()
        self.list_dims.setSelectionMode(QListWidget.MultiSelection)
        self.list_dims.addItems(self.df.columns)
        settings_layout.addWidget(self.list_dims)

        # æŒ‰é’®
        self.btn_plot = QPushButton("ğŸ“Š ç”Ÿæˆåˆ†å¸ƒå›¾")
        self.btn_plot.setStyleSheet("background-color: #2196F3; color: white; font-weight: bold; padding: 8px;")
        self.btn_plot.clicked.connect(self.plot_data)
        settings_layout.addWidget(self.btn_plot)
        
        self.btn_copy = QPushButton("ğŸ“‹ å¤åˆ¶å›¾ç‰‡åˆ°å‰ªè´´æ¿")
        self.btn_copy.clicked.connect(self.copy_to_clipboard)
        settings_layout.addWidget(self.btn_copy)

        settings_layout.addStretch()
        layout.addWidget(settings_panel)

        # === å³ä¾§ï¼šç»˜å›¾åŒº ===
        # ä½¿ç”¨ Matplotlib çš„ FigureCanvas
        self.figure = Figure(figsize=(8, 6), dpi=100)
        self.canvas = FigureCanvas(self.figure)
        layout.addWidget(self.canvas, stretch=1)

    def plot_data(self):
        target_col = self.combo_col.currentText()
        dim_cols = [item.text() for item in self.list_dims.selectedItems()]
        
        # é˜²æ­¢é€‰æ‹©è‡ªå·±ä½œä¸ºåˆ†ç»„
        if target_col in dim_cols:
            dim_cols.remove(target_col)

        # === æ•°æ®å‡†å¤‡é˜¶æ®µ (Polars é«˜é€Ÿå¤„ç†) ===
        try:
            # 1. é€‰åˆ— (ç›®æ ‡åˆ— + ç»´åº¦åˆ—)
            # ä½¿ç”¨ lazy æ¨¡å¼æˆ–ç›´æ¥ eager
            work_df = self.df.select([target_col] + dim_cols)

            # 2. ç±»å‹è½¬æ¢ (ä¸å½±å“åŸå§‹æ•°æ®)
            is_numeric = True
            if self.rb_float.isChecked():
                # strict=False ä¼šå°†æ— æ³•è§£æçš„è½¬ä¸º null
                work_df = work_df.with_columns(pl.col(target_col).cast(pl.Float64, strict=False))
            elif self.rb_int.isChecked():
                work_df = work_df.with_columns(pl.col(target_col).cast(pl.Int64, strict=False))
            else:
                is_numeric = False
                work_df = work_df.with_columns(pl.col(target_col).cast(pl.String))

            # 3. ç©ºå€¼å¤„ç†
            if self.rb_drop.isChecked():
                work_df = work_df.drop_nulls(subset=[target_col])
            else:
                fill_val = 0 if is_numeric else ""
                work_df = work_df.with_columns(pl.col(target_col).fill_null(fill_val))

            # === ç»˜å›¾é€»è¾‘ ===
            self.figure.clear()
            
            # å¦‚æœæ²¡æœ‰æ•°æ®
            if work_df.height == 0:
                ax = self.figure.add_subplot(111)
                ax.text(0.5, 0.5, "å½“å‰æ¡ä»¶ä¸‹æ— æœ‰æ•ˆæ•°æ®", ha='center', va='center', fontsize=14)
                self.canvas.draw()
                return

            # å¦‚æœæ²¡æœ‰åˆ†ç»„ç»´åº¦ -> å•å›¾
            if not dim_cols:
                ax = self.figure.add_subplot(111)
                self.draw_single_plot(ax, work_df, target_col, is_numeric, "æ€»åˆ†å¸ƒ")
            
            else:
                # å¤šç»´åº¦åˆ†ç»„ -> Faceting
                # 1. è·å–æ‰€æœ‰ç»„åˆ
                # ç»„åˆæˆä¸€ä¸ª struct æˆ–è€… concat string æ¥åˆ†ç»„
                # ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å¯¹ç»´åº¦è¿›è¡Œ sort å¹¶å»é‡
                groups = work_df.select(dim_cols).unique().sort(dim_cols)
                n_groups = groups.height
                
                if n_groups > 16:
                    QMessageBox.warning(self, "è­¦å‘Š", f"åˆ†ç»„è¿‡å¤š ({n_groups}ç»„)ï¼Œä»…æ˜¾ç¤ºå‰16ç»„ã€‚")
                    groups = groups.head(16)
                    n_groups = 16

                # è®¡ç®—å­å›¾è¡Œåˆ— (ä¾‹å¦‚ 12ä¸ª -> 3x4)
                import math
                cols = min(4, n_groups)
                rows = math.ceil(n_groups / cols)

                # éå†ç»˜åˆ¶
                for i in range(n_groups):
                    # è·å–å½“å‰ç»„çš„è¿‡æ»¤æ¡ä»¶
                    current_group_row = groups.row(i) # tuple ('A1', 'B1')
                    
                    # æ„å»º filter è¡¨è¾¾å¼
                    filter_expr = pl.lit(True)
                    group_label_parts = []
                    
                    for dim_idx, dim_val in enumerate(current_group_row):
                        col_name = dim_cols[dim_idx]
                        if dim_val is None:
                            filter_expr = filter_expr & pl.col(col_name).is_null()
                            group_label_parts.append(f"{col_name}=Null")
                        else:
                            filter_expr = filter_expr & (pl.col(col_name) == dim_val)
                            group_label_parts.append(f"{col_name}={dim_val}")
                    
                    sub_df = work_df.filter(filter_expr)
                    
                    # æ·»åŠ å­å›¾
                    ax = self.figure.add_subplot(rows, cols, i+1)
                    title = "\n".join(group_label_parts) # æ¢è¡Œæ˜¾ç¤ºæ ‡ç­¾ï¼Œé˜²æ­¢å¤ªé•¿
                    self.draw_single_plot(ax, sub_df, target_col, is_numeric, title)

            self.figure.tight_layout()
            self.canvas.draw()

        except Exception as e:
            QMessageBox.critical(self, "ç»˜å›¾é”™è¯¯", str(e))
            import traceback
            print(traceback.format_exc())

    def draw_single_plot(self, ax, df, col_name, is_numeric, title):
        """é€šç”¨å•å›¾ç»˜åˆ¶å‡½æ•°"""
        data = df.get_column(col_name).to_list()
        
        ax.set_title(title, fontsize=10)
        ax.grid(True, linestyle='--', alpha=0.6)

        if is_numeric:
            # æ•°å€¼å‹ï¼šç›´æ–¹å›¾ + ç®±çº¿å›¾ (å¯é€‰ï¼Œè¿™é‡Œåªç”»ç›´æ–¹å›¾)
            # è‡ªåŠ¨è®¡ç®— bins
            if len(data) > 0:
                ax.hist(data, bins=20, color='#4CAF50', alpha=0.7, edgecolor='black')
                ax.set_ylabel("é¢‘æ•°")
        else:
            # æ–‡æœ¬å‹ï¼šæ¡å½¢è®¡æ•°å›¾ (Value Counts)
            # Polars value_counts
            vc = df.select(pl.col(col_name).value_counts(sort=True)).unnest(col_name)
            # å–å‰ 10 ä¸ªï¼Œé˜²æ­¢æ–‡æœ¬ç§ç±»å¤ªå¤šæŒ¤çˆ†Xè½´
            vc = vc.head(10)
            
            cats = vc.get_column(col_name).to_list()
            counts = vc.get_column("count").to_list()
            
            # è¿™é‡Œçš„ cats å¯èƒ½æ˜¯ null
            cats = [str(c) if c is not None else "Null" for c in cats]
            
            ax.bar(cats, counts, color='#2196F3', alpha=0.7)
            ax.set_ylabel("è®¡æ•°")
            # Xè½´æ ‡ç­¾æ—‹è½¬ï¼Œé˜²æ­¢é‡å 
            ax.tick_params(axis='x', rotation=45)

    def copy_to_clipboard(self):
        """å°†å½“å‰ Matplotlib ç”»å¸ƒå¤åˆ¶åˆ°å‰ªè´´æ¿"""
        buf = io.BytesIO()
        self.figure.savefig(buf, format='png', dpi=150)
        buf.seek(0)
        
        # å°† buffer è½¬ä¸º QImage
        image = QImage.fromData(buf.getvalue())
        QApplication.clipboard().setImage(image)
        QMessageBox.information(self, "æˆåŠŸ", "å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")

from PySide6.QtWidgets import QComboBox, QRadioButton, QButtonGroup

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("DataForge - Pythoné«˜æ€§èƒ½æ•°æ®å·¥åŠ")
        self.resize(1400, 900)
        self.exporter = None
        
        # æ ¸å¿ƒæ•°æ®å­˜å‚¨: {'filename': DataFrame}
        self.dfs = {} 
        # å­˜å‚¨å…ƒæ•°æ®: {'filename': {'orig_shape': (r,c)}}
        self.meta = {}
        
        self.setup_ui()

    def setup_ui(self):
        main_widget = QWidget()
        self.setCentralWidget(main_widget)
        main_layout = QHBoxLayout(main_widget)

        # === ä¾§è¾¹æ ï¼šæ–‡ä»¶ç®¡ç† ===
        splitter = QSplitter(Qt.Horizontal)
        main_layout.addWidget(splitter)

        left_panel = QWidget()
        left_layout = QVBoxLayout(left_panel)
        
        # æŒ‰é’®åŒº
        btn_layout = QHBoxLayout()
        self.btn_load = QPushButton("ğŸ“‚ åŠ è½½æ–‡ä»¶")
        self.btn_load.clicked.connect(self.load_files)
        self.btn_dup = QPushButton("ğŸ” æŸ¥é‡")
        self.btn_dup.clicked.connect(self.open_duplicate_check)
        # === æ–°å¢æŒ‰é’® ===
        self.btn_viz = QPushButton("ğŸ“Š åˆ†å¸ƒ")
        self.btn_viz.clicked.connect(self.open_distribution_view)
        self.btn_export = QPushButton("ğŸ’¾ å¯¼å‡º")
        self.btn_export.clicked.connect(self.export_current)
        btn_layout.addWidget(self.btn_load)
        btn_layout.addWidget(self.btn_dup)
        btn_layout.addWidget(self.btn_viz) # æ·»åŠ åˆ°å¸ƒå±€
        btn_layout.addWidget(self.btn_export)
        left_layout.addLayout(btn_layout)

        # æ–‡ä»¶åˆ—è¡¨è¡¨æ ¼
        self.file_table = QTableWidget()
        self.file_table.setColumnCount(4)
        self.file_table.setHorizontalHeaderLabels(["è¡¨å (Key)", "åŸå§‹è¡Œåˆ—", "å½“å‰è¡Œåˆ—", "çŠ¶æ€"])
        self.file_table.horizontalHeader().setSectionResizeMode(QHeaderView.Stretch)
        self.file_table.setSelectionBehavior(QTableWidget.SelectRows)
        left_layout.addWidget(self.file_table)
        
        # è¿›åº¦æ¡
        self.progress_bar = QProgressBar()
        self.progress_bar.setVisible(False)
        left_layout.addWidget(self.progress_bar)

        splitter.addWidget(left_panel)

        # === å³ä¾§ï¼šä»£ç ä¸æ—¥å¿— ===
        right_panel = QWidget()
        right_layout = QVBoxLayout(right_panel)
        
        # é¡¶éƒ¨ï¼šä»£ç æ§åˆ¶
        code_ctrl_layout = QHBoxLayout()
        code_ctrl_layout.addWidget(QLabel("<b>Python ä»£ç æ“ä½œåŒº (å·²æ³¨å…¥å˜é‡: dfs, pl)</b>"))
        self.btn_run = QPushButton("â–¶ è¿è¡Œä»£ç ")
        self.btn_run.setStyleSheet("background-color: #4CAF50; color: white; font-weight: bold;")
        self.btn_run.clicked.connect(self.run_code)
        code_ctrl_layout.addWidget(self.btn_run)
        code_ctrl_layout.addStretch()
        right_layout.addLayout(code_ctrl_layout)

        # ä»£ç ç¼–è¾‘å™¨
        self.code_edit = QPlainTextEdit()
        self.code_edit.setPlaceholderText("# ç¤ºä¾‹:\n# df = dfs['filename']\n# df = df.filter(...)\n# dfs['filename'] = df")
        self.code_edit.setStyleSheet("font-family: Consolas, monospace; font-size: 11pt; background-color: #2b2b2b; color: #f8f8f2;")
        right_layout.addWidget(self.code_edit, stretch=2)

        # å†å²è®°å½•/æ—¥å¿—
        right_layout.addWidget(QLabel("è¿è¡Œæ—¥å¿— / å†å²:"))
        self.log_view = QListWidget()
        right_layout.addWidget(self.log_view, stretch=1)

        splitter.addWidget(right_panel)
        splitter.setSizes([500, 900])

    def log(self, message, is_error=False):
        timestamp = datetime.now().strftime("%H:%M:%S")
        item = QListWidgetItem(f"[{timestamp}] {message}")
        if is_error:
            item.setForeground(Qt.red)
        self.log_view.addItem(item)
        self.log_view.scrollToBottom()

    # === åŠŸèƒ½å®ç°: åŠ è½½æ–‡ä»¶ ===
    def load_files(self):
        files, _ = QFileDialog.getOpenFileNames(self, "é€‰æ‹©Excelæ–‡ä»¶", "", "Excel Files (*.xlsx)")
        if not files:
            return

        self.btn_load.setDisabled(True)
        self.progress_bar.setVisible(True)
        self.progress_bar.setRange(0, 0) # æ— é™æ¨¡å¼

        self.loader = DataLoader(files)
        self.loader.progress.connect(self.log)
        self.loader.finished_one.connect(self.on_file_loaded)
        self.loader.all_finished.connect(self.on_load_complete)
        self.loader.start()

    def on_file_loaded(self, filename, df, original_shape):
        self.dfs[filename] = df
        self.meta[filename] = {'orig_shape': original_shape}
        self.update_table_row(filename)
        self.log(f"å·²åŠ è½½: {filename} {original_shape}")

    def on_load_complete(self):
        self.btn_load.setDisabled(False)
        self.progress_bar.setVisible(False)
        self.log("æ‰€æœ‰æ–‡ä»¶åŠ è½½å®Œæ¯•")

    def update_table_row(self, filename):
        """æ›´æ–°æ–‡ä»¶åˆ—è¡¨ä¸­çš„æŸä¸€è¡Œï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ–°å¢"""
        row_idx = -1
        # æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨
        for r in range(self.file_table.rowCount()):
            if self.file_table.item(r, 0).text() == filename:
                row_idx = r
                break
        
        if row_idx == -1:
            row_idx = self.file_table.rowCount()
            self.file_table.insertRow(row_idx)
            self.file_table.setItem(row_idx, 0, QTableWidgetItem(filename))

        # è·å–æ•°æ®
        df = self.dfs.get(filename)
        if df is None: return

        orig = self.meta.get(filename, {}).get('orig_shape', (0,0))
        curr = df.shape
        
        self.file_table.setItem(row_idx, 1, QTableWidgetItem(f"{orig[0]}è¡Œ, {orig[1]}åˆ—"))
        self.file_table.setItem(row_idx, 2, QTableWidgetItem(f"{curr[0]}è¡Œ, {curr[1]}åˆ—"))
        
        # çŠ¶æ€ç€è‰²
        status_item = QTableWidgetItem("Ready")
        if curr != orig:
            status_item.setText("Modified")
            status_item.setForeground(Qt.blue)
        self.file_table.setItem(row_idx, 3, status_item)

    # === åŠŸèƒ½å®ç°: æŸ¥é‡ ===
    def open_duplicate_check(self):
        selected_rows = self.file_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "æç¤º", "è¯·å…ˆåœ¨å·¦ä¾§åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªå·¥ä½œè¡¨")
            return
        
        filename = self.file_table.item(selected_rows[0].row(), 0).text()
        df = self.dfs.get(filename)
        
        dialog = DuplicateCheckDialog(df, self)
        if dialog.exec() == QDialog.Accepted:
            # æ›´æ–° DataFrame
            self.dfs[filename] = dialog.result_df
            self.update_table_row(filename)
            self.log(f"è¡¨ {filename} å·²å»é‡ã€‚æ–°è¡Œæ•°: {dialog.result_df.shape[0]}")

    # === åŠŸèƒ½å®ç°: å¯¼å‡º (å¤šçº¿ç¨‹ç‰ˆ) ===
    def export_current(self):
        # 1. è·å–é€‰ä¸­çš„è¡Œ
        selected_rows = self.file_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "æç¤º", "è¯·é€‰æ‹©è¦å¯¼å‡ºçš„è¡¨")
            return

        # 2. é€‰æ‹©ä¿å­˜ç›®å½•
        target_dir = QFileDialog.getExistingDirectory(self, "é€‰æ‹©å¯¼å‡ºæ–‡ä»¶å¤¹")
        if not target_dir:
            return

        # 3. å‡†å¤‡å¯¼å‡ºä»»åŠ¡åˆ—è¡¨
        export_tasks = []
        for idx in selected_rows:
            filename = self.file_table.item(idx.row(), 0).text()
            df = self.dfs.get(filename)
            if df is not None:
                save_path = os.path.join(target_dir, f"{filename}.xlsx")
                export_tasks.append((filename, df, save_path))

        if not export_tasks:
            return

        # 4. é”å®šç•Œé¢ï¼Œé˜²æ­¢é‡å¤æ“ä½œ
        self.btn_export.setEnabled(False)
        self.progress_bar.setVisible(True)
        self.progress_bar.setRange(0, len(export_tasks)) # è®¾ç½®è¿›åº¦æ¡æœ€å¤§å€¼
        self.progress_bar.setValue(0)

        # 5. å¯åŠ¨åå°çº¿ç¨‹
        self.exporter = ExportWorker(export_tasks)
        self.exporter.progress.connect(self.log)
        self.exporter.finished_one.connect(self.on_export_one_finished) # æ›´æ–°è¿›åº¦æ¡
        self.exporter.error_occurred.connect(lambda msg: self.log(msg, True))
        self.exporter.all_finished.connect(self.on_export_all_finished)
        self.exporter.start()

    def on_export_one_finished(self, msg):
        """å•ä¸ªæ–‡ä»¶å¯¼å‡ºå®Œæˆçš„å›è°ƒ"""
        self.log(msg)
        current_val = self.progress_bar.value()
        self.progress_bar.setValue(current_val + 1)

    def on_export_all_finished(self):
        """æ‰€æœ‰å¯¼å‡ºå®Œæˆçš„å›è°ƒ"""
        self.btn_export.setEnabled(True)
        self.progress_bar.setVisible(False)
        self.log("æ‰€æœ‰å¯¼å‡ºä»»åŠ¡å®Œæˆï¼")
        QMessageBox.information(self, "å®Œæˆ", "å¯¼å‡ºå·²å®Œæˆ")

    # === æ ¸å¿ƒåŠŸèƒ½: è¿è¡Œä»£ç  ===
    def run_code(self):
        code = self.code_edit.toPlainText()
        if not code.strip():
            return

        # å‡†å¤‡æ‰§è¡Œç¯å¢ƒ
        local_scope = {
            'dfs': self.dfs, # å¼•ç”¨ä¼ é€’ï¼Œä¿®æ”¹ dfs ä¼šç›´æ¥å½±å“ self.dfs
            'pl': pl,
            'cs':cs,
            'print': self.log # é‡å®šå‘ print åˆ°æ—¥å¿—
        }

        start_time = time.time()
        try:
            self.log(">>> å¼€å§‹æ‰§è¡Œä»£ç ...")
            exec(code, {}, local_scope)
            
            # ä»£ç æ‰§è¡Œå®Œåï¼ŒUIéœ€è¦åˆ·æ–°
            # å› ä¸º dfs æ˜¯å­—å…¸ï¼Œç”¨æˆ·å¯èƒ½æ·»åŠ äº†æ–°key (joinè¡¨) æˆ–ä¿®æ”¹äº†ç°æœ‰key
            
            # 1. åˆ·æ–°ç°æœ‰çš„
            current_keys = list(self.dfs.keys()) # è·å–æ‰€æœ‰å½“å‰çš„key
            self.file_table.setRowCount(0) # ç®€å•ç²—æš´ï¼šé‡ç»˜åˆ—è¡¨ (ä¸ºäº†å¤„ç†æ–°å¢/åˆ é™¤çš„è¡¨)
            
            for key in current_keys:
                # å¦‚æœæ˜¯æ–°äº§ç”Ÿçš„è¡¨ï¼Œæ²¡æœ‰ original shapeï¼Œè®¾ä¸º (0,0) æˆ– å½“å‰ shape
                if key not in self.meta:
                    self.meta[key] = {'orig_shape': self.dfs[key].shape}
                self.update_table_row(key)

            duration = time.time() - start_time
            self.log(f"<<< æ‰§è¡ŒæˆåŠŸ (è€—æ—¶ {duration:.4f}s)")

        except Exception as e:
            error_msg = traceback.format_exc()
            self.log(f"æ‰§è¡Œå‡ºé”™:\n{error_msg}", True)
            QMessageBox.critical(self, "ä»£ç é”™è¯¯", f"å‘ç”Ÿå¼‚å¸¸:\n{e}")
    # === åŠŸèƒ½å®ç°: æ•°æ®åˆ†å¸ƒé¢„è§ˆ ===
    def open_distribution_view(self):
        selected_rows = self.file_table.selectionModel().selectedRows()
        if not selected_rows:
            QMessageBox.warning(self, "æç¤º", "è¯·å…ˆåœ¨å·¦ä¾§åˆ—è¡¨é€‰æ‹©ä¸€ä¸ªå·¥ä½œè¡¨")
            return
        
        filename = self.file_table.item(selected_rows[0].row(), 0).text()
        df = self.dfs.get(filename)
        
        # ä¼ å…¥ df å’Œæ–‡ä»¶å
        dialog = DataDistributionDialog(df, filename, self)
        dialog.exec()

if __name__ == "__main__":
    app = QApplication(sys.argv)
    
    # è®¾ç½®æ·±è‰²ä¸»é¢˜é£æ ¼ (å¯é€‰)
    app.setStyle("Fusion")
    
    window = MainWindow()
    window.show()
    sys.exit(app.exec())
```
2. è¿è¡Œå¤„ç†ä»£ç 
```
""" æ‰å¹³ """
df = dfs['20260214_15-18_æ‰å¹³ç»“æœ']

# åˆ é™¤ä» "åˆ—A" å¼€å§‹ï¼Œåˆ° "åˆ—B" ç»“æŸçš„æ‰€æœ‰ä¸­é—´åˆ—ï¼ˆå« A å’Œ Bï¼‰
cols = df.columns
# æ ¸å¿ƒï¼šåˆ—è¡¨æ¨å¯¼å¼ + åˆ‡ç‰‡è·å–æ‰€æœ‰ä¸­é—´åˆ—
drop_list = [c for s, e in [
    ('æ“ä½œå‘˜', 'ç‰©æ–™ç¼–ç '), 
    ('æ”¶å£å‰ä¸­å¿ƒå­”å°ºå¯¸ç»“æœ', 'æ”¶å£å·¥ä½å‹åŠ›å€¼'),
    ('æ­£ææ‰å¹³å·¥ä½å‹åŠ›å€¼ç»“æœ', 'è´Ÿæç«¯é¢ç»“æœ'),
    ('ç„Šæ¥åŠŸç‡', 'ç„Šåæ£€æµ‹ç»“æœ'),
    ('ç„Šæ¥å‹åŠ›', 'ç„Šæ¥åŒå¿ƒåº¦')
] for c in cols[cols.index(s) : cols.index(e)+1]]
df = df.drop(drop_list)

# åˆ é™¤å”¯ä¸€å€¼æ•°é‡ç­‰äº 1 çš„åˆ—å’Œç­‰äº2ä½†æ˜¯æœ‰ä¸€ä¸ªå”¯ä¸€å€¼ä¸ºç©ºçš„åˆ—
drop_cols = []
# éå†æ¯ä¸€åˆ—è¿›è¡Œæ£€æŸ¥
for col in df.columns:
    # è·å–è¯¥åˆ—çš„å”¯ä¸€å€¼åˆ—è¡¨
    u_vals = df[col].unique().to_list()
    n = len(u_vals)
    # é€»è¾‘åˆ¤æ–­ï¼š
    # 1. åªæœ‰1ä¸ªå”¯ä¸€å€¼ (ä¾‹å¦‚å…¨åˆ—éƒ½æ˜¯ "OK"ï¼Œæˆ–è€…å…¨åˆ—éƒ½æ˜¯ "0")
    # 2. åªæœ‰2ä¸ªå”¯ä¸€å€¼ï¼Œä¸”å…¶ä¸­åŒ…å«ç©ºå­—ç¬¦ä¸² (ä¾‹å¦‚ ["OK", ""] æˆ– ["", "NG"])
    #    æ³¨æ„ï¼šè¿™é‡Œä¹Ÿé¡ºå¸¦æ£€æŸ¥äº† None/nullï¼Œä»¥é˜²ä¸‡ä¸€
    if n == 1:
        drop_cols.append(col)
    elif n == 2 and ("" in u_vals or None in u_vals):
        drop_cols.append(col)
# æ‰§è¡Œåˆ é™¤
if drop_cols:
    df = df.drop(drop_cols)
    print(f"âœ… å·²æ¸…ç† {len(drop_cols)} åˆ— (å•ä¸€å€¼æˆ–å«ç©ºå€¼):")
    print(drop_cols)
else:
    print("âš ï¸ æœªå‘ç°ç¬¦åˆæ¸…ç†æ¡ä»¶çš„åˆ—")

# æ¸…æ´—æ•°æ®è¡Œ
df = df.filter(~(
    (pl.col('æ‰å¹³åå·èŠ¯é«˜åº¦') == '88.3') |
    ((pl.col('æ‰å¹³åæ­£æè€³å¤–æ¼') == '0.000') & (pl.col('æ‰å¹³åè´Ÿæè€³å¤–æ¼') == '0.000')) |
    (pl.col('æ‰å¹³åæ­£æè€³å¤–æ¼') == '1.2') |
    (pl.col('æ‰å¹³åè´Ÿæè€³å¤–æ¼') == '0.3') |
    (pl.col('æ¡ç ').is_in(['', '0'])) |
    (pl.col('æ‰å¹³å·¥ä½') == '0')
))

# åˆ—æ•°æ®å»é‡ ä¿ç•™ç¬¬ä¸€ä¸ª
df = df.unique(subset=["æ¡ç "], keep="first")

# ä¿®æ”¹åˆ—æ•°æ®æˆ–å¢åŠ åˆ—æ•°æ®
df = df.with_columns([
    pl.col("äº§çº¿åç§°").str.slice(6, 3).alias("äº§çº¿åç§°"),
    (pl.col("è®¾å¤‡åç§°").str.slice(0, 3) + 'æ‰å¹³' + pl.col("è®¾å¤‡åç§°").str.slice(13, 2)).alias("è®¾å¤‡åç§°"),
])

# é‡å‘½å
df = df.rename({"ç£æ‚¬æµ®åŠ¨å­": "åŠ¨å­","äº§çº¿åç§°": 'ç»„è£…äº§çº¿', "è®¾å¤‡åç§°": 'æ‰å¹³è®¾å¤‡'})

# åˆ é™¤æŒ‡å®šåˆ—
df = df.drop(
    cs.starts_with("hi-pot") & ~cs.ends_with("å·¥ä½"),
    "é‡‡é›†æ—¶é—´",
    "æ‰å¹³è¿›ç»™é€Ÿåº¦"
)

# é‡å¤åˆ—åˆ é™¤
preferred_cols = ['æ‰å¹³å·¥ä½'] # åœ¨è¿™é‡Œå¡«å…¥ä¼˜å…ˆä¿ç•™çš„åˆ—
seen = {}    # è®°å½• {å“ˆå¸ŒæŒ‡çº¹: å½“å‰ç¡®å®šçš„ä»£è¡¨åˆ—å}
drops = []   # æœ€ç»ˆå¾…åˆ é™¤çš„é‡å¤åˆ—
for col in df.columns:
    # è®¡ç®—æŒ‡çº¹
    h = df[col].hash().sum()
    
    if h in seen:
        # æŒ‡çº¹å†²çªï¼Œè¿›è¡Œç²¾ç¡®æ¯”å¯¹
        existing_col = seen[h]
        if df[col].equals(df[existing_col]):
            # --- æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤æ–­è°è¯¥è¢«åˆ é™¤ ---
            # å¦‚æœå½“å‰åˆ—åœ¨ä¼˜å…ˆåå•ä¸­ï¼Œä¸”ä¹‹å‰çš„åˆ—ä¸åœ¨ä¼˜å…ˆåå•ä¸­ï¼š
            if col in preferred_cols and existing_col not in preferred_cols:
                drops.append(existing_col) # æŠ›å¼ƒä¹‹å‰è®°å½•çš„åˆ—
                seen[h] = col              # å°†å½“å‰åˆ—è®¾ä¸ºè¯¥å†…å®¹çš„â€œä»£è¡¨â€
                # print(f"ğŸ”„ æ›¿æ¢ï¼šç”±äº {col} åœ¨ä¼˜å…ˆåå•ï¼Œèˆå¼ƒäº† {existing_col}")
            else:
                # å¦åˆ™ï¼Œé»˜è®¤åˆ é™¤å½“å‰åˆ— (æˆ–è€…æ˜¯ä¹‹å‰çš„åˆ—å·²ç»åœ¨ä¼˜å…ˆåå•ä¸­äº†)
                drops.append(col)
    else:
        seen[h] = col # ç¬¬ä¸€æ¬¡é‡è§è¯¥å†…å®¹
# 3. æ‰§è¡Œåˆ é™¤
if drops:
    # æ³¨æ„ï¼šå¦‚æœåŒä¸€ç»„é‡å¤åˆ—æœ‰å¤šä¸ªéƒ½åœ¨ä¼˜å…ˆåå•ï¼Œä¸Šé¢çš„é€»è¾‘ä¼šä¿ç•™æœ€å…ˆå‡ºç°çš„é‚£ä¸ªä¼˜å…ˆåˆ—
    df = df.drop(drops)
    print(f"âœ… å¤„ç†å®Œæˆï¼åˆ é™¤äº† {len(drops)} ä¸ªé‡å¤åˆ—ã€‚")
    print(f"ğŸ—‘ï¸ è¢«åˆ é™¤çš„åˆ—: {drops}")
else:
    print("âš ï¸ æ²¡æœ‰å‘ç°å†…å®¹é‡å¤çš„åˆ—")

# æ›´æ–°
dfs['20260214_15-18_æ‰å¹³ç»“æœ'] = df


""" åˆ‡å·è¿‡ç¨‹ """
df = dfs['20260214_13-16_é›†æˆåˆ‡å·è¿‡ç¨‹']
cols = df.columns
drop_list = [c for s, e in [
    ('æ“ä½œå‘˜', 'ç‰©æ–™ç¼–ç ')
] for c in cols[cols.index(s) : cols.index(e)+1]]
df = df.drop(drop_list)

# åŸºäºå”¯ä¸€å€¼åˆ é™¤åˆ—
drop_cols = []
for col in df.columns:
    u_vals = df[col].unique().to_list()
    n = len(u_vals)
    if n == 1:
        drop_cols.append(col)
    elif n == 2 and ("" in u_vals or None in u_vals):
        drop_cols.append(col)
if drop_cols:
    df = df.drop(drop_cols)
    print(f"âœ… å·²æ¸…ç† {len(drop_cols)} åˆ— (å•ä¸€å€¼æˆ–å«ç©ºå€¼):")
    print(drop_cols)
else:
    print("âš ï¸ æœªå‘ç°ç¬¦åˆæ¸…ç†æ¡ä»¶çš„åˆ—")

df = df.filter(~( 
    (pl.col('æ­£ææè€³é«˜åº¦å‡å€¼')=='0.000') | 
    (pl.col('è´Ÿææè€³é«˜åº¦å‡å€¼')=='0.000') |
    (pl.col('æ¡ç ').is_in(['', '0']))
))
df = df.unique(subset=["æ¡ç "], keep="first")
df = df.with_columns([
    pl.col("äº§çº¿åç§°").str.slice(6, 3).alias("äº§çº¿åç§°"),
    (pl.col("è®¾å¤‡åç§°").str.slice(0, 3) + 'åˆ‡å·' + pl.col("è®¾å¤‡åç§°").str.slice(9, 2)).alias("è®¾å¤‡åç§°"),
])
df = df.rename({"äº§çº¿åç§°": 'åˆ‡å·äº§çº¿', "è®¾å¤‡åç§°": 'åˆ‡å·è®¾å¤‡'})

# åˆ é™¤é‡å¤å€¼
seen = {}
drops = []
for col in df.columns:
    h = df[col].hash().sum()
    if h in seen:
        first_col = seen[h]
        if df[col].equals(df[first_col]):
            drops.append(col)
    else:
        seen[h] = col
if drops:
    df = df.drop(drops)
    print(f"âœ… å·²åˆ é™¤ {len(drops)} ä¸ªé‡å¤åˆ—: {drops}")
else:
    print("âš ï¸ æ²¡æœ‰å‘ç°å†…å®¹é‡å¤çš„åˆ—")

df = df.drop(
    "é‡‡é›†æ—¶é—´",
    "æ­£ææ¨¡åˆ‡é€Ÿåº¦"
)

dfs['20260214_13-16_é›†æˆåˆ‡å·è¿‡ç¨‹'] = df

""" åˆ‡å·ç»“æœ """
df = dfs['20260214_13-16_é›†æˆåˆ‡å·ç»“æœ']
cols = df.columns
drop_list = [c for s, e in [
    ('è®¾å¤‡åç§°', 'ç‰©æ–™ç¼–ç ')
] for c in cols[cols.index(s) : cols.index(e)+1]]
df = df.drop(drop_list)

# åŸºäºå”¯ä¸€å€¼åˆ é™¤åˆ—
drop_cols = []
for col in df.columns:
    u_vals = df[col].unique().to_list()
    n = len(u_vals)
    if n == 1:
        drop_cols.append(col)
    elif n == 2 and ("" in u_vals or None in u_vals):
        drop_cols.append(col)
if drop_cols:
    df = df.drop(drop_cols)
    print(f"âœ… å·²æ¸…ç† {len(drop_cols)} åˆ— (å•ä¸€å€¼æˆ–å«ç©ºå€¼):")
    print(drop_cols)
else:
    print("âš ï¸ æœªå‘ç°ç¬¦åˆæ¸…ç†æ¡ä»¶çš„åˆ—")

df = df.filter(~( 
    (pl.col('æ¡ç ').is_in(['', '0']))
))
df = df.unique(subset=["æ¡ç "], keep="first")

# åˆ é™¤é‡å¤å€¼
seen = {}
drops = []
for col in df.columns:
    h = df[col].hash().sum()
    if h in seen:
        first_col = seen[h]
        if df[col].equals(df[first_col]):
            drops.append(col)
    else:
        seen[h] = col
if drops:
    df = df.drop(drops)
    print(f"âœ… å·²åˆ é™¤ {len(drops)} ä¸ªé‡å¤åˆ—: {drops}")
else:
    print("âš ï¸ æ²¡æœ‰å‘ç°å†…å®¹é‡å¤çš„åˆ—")

df = df.drop(
    "é‡‡é›†æ—¶é—´",
    "æ­£ææ¨¡åˆ‡é€Ÿåº¦"
)

dfs['20260214_13-16_é›†æˆåˆ‡å·ç»“æœ'] = df

""" å…³è” """
df = dfs['20260214_15-18_æ‰å¹³ç»“æœ'].join(
    dfs['20260214_13-16_é›†æˆåˆ‡å·è¿‡ç¨‹'], 
    on="æ¡ç ", 
    how="inner", 
    suffix="_2"
) # å¢åŠ å…³è”è¡¨

# åŸºäºå”¯ä¸€å€¼åˆ é™¤åˆ—
drop_cols = []
for col in df.columns:
    u_vals = df[col].unique().to_list()
    n = len(u_vals)
    if n == 1:
        drop_cols.append(col)
    elif n == 2 and ("" in u_vals or None in u_vals):
        drop_cols.append(col)
if drop_cols:
    df = df.drop(drop_cols)
    print(f"âœ… å·²æ¸…ç† {len(drop_cols)} åˆ— (å•ä¸€å€¼æˆ–å«ç©ºå€¼):")
    print(drop_cols)
else:
    print("âš ï¸ æœªå‘ç°ç¬¦åˆæ¸…ç†æ¡ä»¶çš„åˆ—")

# é‡å¤åˆ—åˆ é™¤
preferred_cols = ['æ‰å¹³å·¥ä½'] # åœ¨è¿™é‡Œå¡«å…¥ä¼˜å…ˆä¿ç•™çš„åˆ—
seen = {}    # è®°å½• {å“ˆå¸ŒæŒ‡çº¹: å½“å‰ç¡®å®šçš„ä»£è¡¨åˆ—å}
drops = []   # æœ€ç»ˆå¾…åˆ é™¤çš„é‡å¤åˆ—
for col in df.columns:
    # è®¡ç®—æŒ‡çº¹
    h = df[col].hash().sum()
    
    if h in seen:
        # æŒ‡çº¹å†²çªï¼Œè¿›è¡Œç²¾ç¡®æ¯”å¯¹
        existing_col = seen[h]
        if df[col].equals(df[existing_col]):
            # --- æ ¸å¿ƒé€»è¾‘ï¼šåˆ¤æ–­è°è¯¥è¢«åˆ é™¤ ---
            # å¦‚æœå½“å‰åˆ—åœ¨ä¼˜å…ˆåå•ä¸­ï¼Œä¸”ä¹‹å‰çš„åˆ—ä¸åœ¨ä¼˜å…ˆåå•ä¸­ï¼š
            if col in preferred_cols and existing_col not in preferred_cols:
                drops.append(existing_col) # æŠ›å¼ƒä¹‹å‰è®°å½•çš„åˆ—
                seen[h] = col              # å°†å½“å‰åˆ—è®¾ä¸ºè¯¥å†…å®¹çš„â€œä»£è¡¨â€
                # print(f"ğŸ”„ æ›¿æ¢ï¼šç”±äº {col} åœ¨ä¼˜å…ˆåå•ï¼Œèˆå¼ƒäº† {existing_col}")
            else:
                # å¦åˆ™ï¼Œé»˜è®¤åˆ é™¤å½“å‰åˆ— (æˆ–è€…æ˜¯ä¹‹å‰çš„åˆ—å·²ç»åœ¨ä¼˜å…ˆåå•ä¸­äº†)
                drops.append(col)
    else:
        seen[h] = col # ç¬¬ä¸€æ¬¡é‡è§è¯¥å†…å®¹
# 3. æ‰§è¡Œåˆ é™¤
if drops:
    # æ³¨æ„ï¼šå¦‚æœåŒä¸€ç»„é‡å¤åˆ—æœ‰å¤šä¸ªéƒ½åœ¨ä¼˜å…ˆåå•ï¼Œä¸Šé¢çš„é€»è¾‘ä¼šä¿ç•™æœ€å…ˆå‡ºç°çš„é‚£ä¸ªä¼˜å…ˆåˆ—
    df= df.drop(drops)
    print(f"âœ… å¤„ç†å®Œæˆï¼åˆ é™¤äº† {len(drops)} ä¸ªé‡å¤åˆ—ã€‚")
    print(f"ğŸ—‘ï¸ è¢«åˆ é™¤çš„åˆ—: {drops}")
else:
    print("âš ï¸ æ²¡æœ‰å‘ç°å†…å®¹é‡å¤çš„åˆ—")

dfs['å…¨å…³è”'] = df

# ç­›é€‰è‰¯å“
df = df.filter(~(
    (pl.col('ä¸è‰¯é¡¹').str.contains('NG'))
))
# ä½¿ç”¨ horizontal é€»è¾‘æ¨ªå‘æ‰«ææ‰€æœ‰å­—ç¬¦ä¸²åˆ—
df = df.filter(
    ~pl.any_horizontal(
        cs.string() == ""
    )
)
dfs['è‰¯å“å…³è”'] = df
```
3. æ•°æ®åˆ†æç•Œé¢
```
import sys
import time
from enum import Enum
from typing import Dict, List, Any, Tuple

# é«˜æ€§èƒ½è®¡ç®—åº“
import polars as pl
import numpy as np

# GUIåº“
from PySide6.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, 
                               QHBoxLayout, QPushButton, QFileDialog, QTableView, 
                               QLabel, QCheckBox, QSplitter, QComboBox, 
                               QProgressBar, QTextEdit, QGroupBox, QScrollArea)
from PySide6.QtCore import Qt, QAbstractTableModel, QThread, Signal

# æœºå™¨å­¦ä¹ ä¸ç»Ÿè®¡
from sklearn.preprocessing import LabelEncoder
import lightgbm as lgb

# ==========================================
# 1. æ ¸å¿ƒæ•°æ®å¼•æ“ (Polars)
# ==========================================

class ColumnType(Enum):
    IGNORE = "ä¸å‚ä¸åˆ†æ"
    NUMERIC = "æ•°å€¼"
    CATEGORY = "æ–‡æœ¬/ç±»åˆ«"

class DataEngine:
    """
    è´Ÿè´£æ•°æ®çš„è¯»å–ã€ç±»å‹å¼ºåˆ¶è½¬æ¢å’Œæ¸…æ´—
    """
    
    @staticmethod
    def load_and_convert(path: str) -> Tuple[pl.DataFrame, Dict[str, ColumnType]]:
        """
        è¯»å– Excelï¼Œå¹¶æ‰§è¡Œï¼šé»˜è®¤è½¬æ•°å­—ï¼Œè½¬ä¸äº†çš„ä¸ºæ–‡æœ¬
        """
        # 1. è¯»å– Excel (å»ºè®®å®‰è£… fastexcel: pip install fastexcel)
        # infer_schema_length=0 æ„å‘³ç€å¼ºåˆ¶æ‰€æœ‰åˆ—ä»¥ String è¯»å–ï¼Œç¡®ä¿åŸå§‹æ•°æ®ä¸ä¸¢å¤±
        try:
            df_raw = pl.read_excel(path, sheet_id=1, engine="fastexcel", infer_schema_length=0)
        except:
            # å…¼å®¹æ€§å›é€€
            df_raw = pl.read_excel(path, sheet_id=1, infer_schema_length=0)

        final_types = {}
        valid_cols = []
        
        # 2. éå†åˆ—è¿›è¡Œç±»å‹â€œå°è¯•è½¬æ¢â€
        # ä½¿ç”¨ LazyFrame ä¼˜åŒ–æ€§èƒ½ï¼Œä½†ä¸ºäº†ç±»å‹æ¨æ–­éœ€è¦å³æ—¶æ‰§è¡Œéƒ¨åˆ†é€»è¾‘
        df_processed = df_raw.clone()
        
        transform_exprs = []
        
        for col in df_raw.columns:
            # å°è¯•è½¬æ¢ä¸º Float64ï¼Œstrict=False ä¼šå°†æ— æ³•è½¬æ¢çš„å˜ä¸º null
            # strip_chars() å»é™¤å¯èƒ½å­˜åœ¨çš„ç©ºæ ¼
            s_str = df_raw[col].str.strip_chars()
            s_num = s_str.cast(pl.Float64, strict=False)
            
            # ç»Ÿè®¡è½¬æ¢åçš„æƒ…å†µ
            original_nulls = s_str.null_count()
            new_nulls = s_num.null_count()
            total_rows = df_raw.height
            
            # åˆ¤å®šé€»è¾‘ï¼š
            # å¦‚æœåŸæœ¬ä¸æ˜¯nullï¼Œè½¬æ¢åå˜æˆäº†nullï¼Œè¯´æ˜æ˜¯æ–‡æœ¬æ— æ³•è½¬æ•°å­—
            # æˆ‘ä»¬å…è®¸æå°‘é‡çš„è½¬æ¢å¤±è´¥ï¼ˆæ¯”å¦‚è¡¨å¤´ä¸‹çš„å•ä½è¡Œï¼‰ï¼Œä½†å¦‚æœå¤§é‡å¤±è´¥åˆ™è®¤ä¸ºæ˜¯æ–‡æœ¬
            failed_conversion_count = new_nulls - original_nulls
            
            is_numeric = False
            
            if failed_conversion_count < (total_rows * 0.2): # é˜ˆå€¼ï¼šå¦‚æœåªæœ‰ä¸åˆ°20%çš„æ•°æ®è½¬æ¢å¤±è´¥ï¼Œå°è¯•æŠ¢æ•‘
                # å¦‚æœæ•´åˆ—éƒ½æ˜¯æ•°å­—ï¼Œé‚£å°±å®šä¸º NUMERIC
                is_numeric = True
                transform_exprs.append(s_num.alias(col)) # æ›¿æ¢ä¸ºæ•°å­—åˆ—
                final_types[col] = ColumnType.NUMERIC
            else:
                # è½¬æ¢å¤±è´¥å¤ªå¤šï¼Œä¿æŒä¸ºæ–‡æœ¬
                is_numeric = False
                transform_exprs.append(s_str.alias(col)) # ä¿æŒæ¸…æ´—è¿‡ç©ºæ ¼çš„æ–‡æœ¬
                final_types[col] = ColumnType.CATEGORY

            # é»˜è®¤å‹¾é€‰é€»è¾‘ï¼šå¦‚æœæ˜¯"æ¡ç "æˆ–å…¨ç©ºï¼Œé»˜è®¤å¿½ç•¥
            if "æ¡ç " in col or new_nulls == total_rows:
                final_types[col] = ColumnType.IGNORE
            elif is_numeric:
                final_types[col] = ColumnType.NUMERIC
            else:
                final_types[col] = ColumnType.CATEGORY

        # æ‰§è¡Œæ‰€æœ‰åˆ—çš„è½¬æ¢
        df_final = df_raw.select(transform_exprs)
        
        return df_final, final_types

    @staticmethod
    def clean_outliers_mad(series: pl.Series, threshold: float = 5.0) -> pl.Series:
        """
        ä½¿ç”¨ MAD (Median Absolute Deviation) ç®—æ³•æ¸…æ´—æ•°å€¼åˆ—ã€‚
        å¯ä»¥åŒºåˆ† "0, 10, 11" ä¸­çš„ 0 (å¼‚å¸¸) å’Œ "-1, 0, 1" ä¸­çš„ 0 (æ­£å¸¸)ã€‚
        """
        # æ’é™¤ null
        s = series.drop_nulls()
        if s.len() < 3: return series

        median = s.median()
        # è®¡ç®—ç»å¯¹ä¸­ä½å·®
        mad = (s - median).abs().median()
        
        # å¦‚æœ MAD ä¸º 0 (ä¾‹å¦‚æ•°æ®æ˜¯ 10, 10, 10, 10, 0)ï¼Œ
        # è¯´æ˜ç»å¤§å¤šæ•°æ•°æ®æ˜¯ä¸€æ ·çš„ï¼Œæ­¤æ—¶ç”¨å¹³å‡ç»å¯¹åå·®æˆ–å…¶ä»–æ–¹å¼ï¼Œæˆ–è€…ç›´æ¥è·³è¿‡ä¸¥æ ¼åˆ¤å®š
        if mad == 0:
            # å›é€€ç­–ç•¥ï¼šå¦‚æœåœ¨æå°èŒƒå›´å†…æ³¢åŠ¨ï¼Œå¯èƒ½ä¸éœ€è¦æ¸…æ´—ï¼Œ
            # æˆ–è€…æ•°æ®æœ¬èº«å°±æ˜¯ç¦»æ•£çš„æ•´æ•°ï¼ˆå¦‚å·¥ä½å·ï¼‰ï¼Œæ­¤æ—¶ä¸åº”åˆ é™¤
            return series

        # ä¿®æ­£ç³»æ•° 1.4826 ä½¿å¾— MAD åœ¨æ­£æ€åˆ†å¸ƒä¸‹ä¸€è‡´äºæ ‡å‡†å·®
        limit = threshold * mad * 1.4826
        
        lower = median - limit
        upper = median + limit
        
        # å°†è¶…å‡ºèŒƒå›´çš„å€¼è®¾ä¸º null (Polars expression)
        # æ³¨æ„ï¼šè¿™é‡Œè¿”å›çš„æ˜¯è¡¨è¾¾å¼é€»è¾‘ï¼Œéœ€è¦åœ¨ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
        return series.map_elements(
            lambda x: x if (x is None) or (lower <= x <= upper) else None, 
            return_dtype=pl.Float64
        )

# ==========================================
# 2. åˆ†æçº¿ç¨‹ (Worker)
# ==========================================

class AnalysisWorker(QThread):
    finished = Signal(str) # è¿”å›æ–‡æœ¬æŠ¥å‘Š
    progress = Signal(int)

    def __init__(self, df: pl.DataFrame, col_config: Dict[str, ColumnType], target_col: str):
        super().__init__()
        self.df = df
        self.col_config = col_config
        self.target_col = target_col

    def run(self):
        try:
            self.progress.emit(10)
            report = [f"=== åˆ†ææŠ¥å‘Š: ç›®æ ‡åˆ— [{self.target_col}] ===\n"]
            
            # 1. ç­›é€‰å‚ä¸åˆ†æçš„åˆ—
            active_cols = [c for c, t in self.col_config.items() if t != ColumnType.IGNORE]
            if self.target_col not in active_cols:
                report.append("é”™è¯¯ï¼šç›®æ ‡åˆ—æœªè¢«å‹¾é€‰æˆ–è¢«è®¾ä¸ºå¿½ç•¥ã€‚")
                self.finished.emit("\n".join(report))
                return

            # 2. æ•°æ®æ¸…æ´— (é’ˆå¯¹æ•°å€¼åˆ—å»å™ª)
            # ä½¿ç”¨ LazyFrame é“¾å¼å¤„ç†
            lf = self.df.lazy().select(active_cols)
            
            # æ„å»ºæ¸…æ´—è¡¨è¾¾å¼
            clean_ops = []
            for col in active_cols:
                ctype = self.col_config[col]
                if ctype == ColumnType.NUMERIC and col != self.target_col:
                    # å¯¹ç‰¹å¾åˆ—è¿›è¡Œ MAD æ¸…æ´—ï¼Œå»é™¤ä¸åˆç†çš„ 0 æˆ–æå€¼
                    # æ³¨æ„ï¼šç›®æ ‡åˆ—é€šå¸¸ä¸å»ºè®®ç›²ç›®æ¸…æ´—ï¼Œé™¤éç¡®å®šæ˜¯å™ªéŸ³ï¼Œè¿™é‡Œæš‚ä¸æ¸…ç›®æ ‡åˆ—
                    # æˆ‘ä»¬éœ€è¦å°† Python å‡½æ•°åº”ç”¨åˆ° Polars Seriesï¼Œè¿™é‡Œä¸ºäº†ä»£ç ç®€æ´
                    # åœ¨å¤§æ•°æ®é‡ä¸‹ï¼Œå»ºè®®å…ˆè½¬ pandas æˆ–ä½¿ç”¨ polarsåŸç”Ÿè¡¨è¾¾å¼è¿‘ä¼¼å¤„ç†
                    pass 
            
            # å°† LazyFrame è½¬ä¸º Pandas DataFrame ä»¥ä¾¿è¿›è¡Œå¤æ‚çš„ç»Ÿè®¡åˆ†æ (LightGBM/Sklearn)
            # Polars æ¸…æ´—å¼‚å¸¸å€¼æ¯”è¾ƒéº»çƒ¦ï¼ˆéœ€è¦ map_elementsï¼‰ï¼Œè¿™é‡Œåœ¨ Pandas ä¸­åš MAD æ¸…æ´—æ›´çµæ´»
            df_pd = lf.collect().to_pandas()
            
            self.progress.emit(30)
            
            # --- Pandas é˜¶æ®µçš„æ•°æ®é¢„å¤„ç† ---
            
            # A. æ•°å€¼åˆ—å¼‚å¸¸å€¼å¤„ç† (MADç®—æ³•)
            numeric_cols = [c for c in active_cols if self.col_config[c] == ColumnType.NUMERIC]
            category_cols = [c for c in active_cols if self.col_config[c] == ColumnType.CATEGORY]
            
            report.append(f"å‚ä¸åˆ†æ: æ•°å€¼åˆ— {len(numeric_cols)} ä¸ª, æ–‡æœ¬/ç±»åˆ«åˆ— {len(category_cols)} ä¸ª\n")

            # æ¸…æ´—é€»è¾‘ï¼šéå†æ•°å€¼åˆ—ï¼ŒæŠŠä¸åˆç†çš„å€¼ç½®ä¸º NaN
            rows_before = len(df_pd)
            for col in numeric_cols:
                series = df_pd[col]
                median = series.median()
                mad = (series - median).abs().median()
                if mad > 0:
                    # é˜ˆå€¼è®¾ä¸º 5 (æ¯”è¾ƒå®½æ¾ï¼Œä¿ç•™ -1, 0, 1 è¿™ç§ï¼Œä½†åˆ é™¤ 0, 10, 10 é‡Œçš„ 0)
                    limit = 6 * mad * 1.4826
                    # æ ‡è®°å¼‚å¸¸å€¼ä¸º NaN
                    mask = (series < (median - limit)) | (series > (median + limit))
                    df_pd.loc[mask, col] = np.nan
            
            # å»é™¤ç›®æ ‡åˆ—ä¸ºç©ºçš„è¡Œ (è¿™æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºæˆ‘ä»¬è¦é¢„æµ‹å®ƒ)
            df_pd = df_pd.dropna(subset=[self.target_col])
            rows_after = len(df_pd)
            report.append(f"æ•°æ®æ¸…æ´—: å‰”é™¤æ— æ•ˆè¡Œåï¼Œå‰©ä½™ {rows_after} è¡Œ (åŸ {rows_before} è¡Œ)")
            
            self.progress.emit(50)

            # 3. å…³ç³»åˆ†æ 1: çº¿æ€§ç›¸å…³æ€§ (Pearson)
            # çœ‹çœ‹å“ªäº›æ•°å€¼åˆ—è·Ÿç›®æ ‡åˆ—ç›´æ¥çº¿æ€§ç›¸å…³
            if len(numeric_cols) > 1:
                corr_matrix = df_pd[numeric_cols].corr(method='pearson')
                if self.target_col in corr_matrix:
                    corrs = corr_matrix[self.target_col].drop(self.target_col).abs().sort_values(ascending=False)
                    report.append("\n--- [çº¿æ€§å…³ç³»] æ•°å€¼åˆ—ç›¸å…³æ€§ Top 5 ---")
                    report.append("(æ•°å€¼è¶Šå¤§å…³ç³»è¶Šç´§å¯†ï¼Œ1.0ä¸ºå®Œå…¨ç›¸å…³)")
                    for idx, val in corrs.head(5).items():
                        report.append(f"  {idx}: {val:.4f}")
            
            self.progress.emit(70)

            # 4. å…³ç³»åˆ†æ 2: éçº¿æ€§ä¸ç»„åˆå…³ç³» (LightGBM)
            # è¿™æ˜¯æ ¸å¿ƒï¼šå¯ä»¥æ•æ‰ "A = B * C" æˆ– "A åœ¨ç±»åˆ« D ä¸‹å— B å½±å“" ç­‰å¤æ‚å…³ç³»
            report.append("\n--- [ç»¼åˆå½±å“åŠ›] å…³é”®å› ç´ æ’è¡Œ (åŸºäºAIæ¨¡å‹) ---")
            report.append("æ­¤æ’è¡Œç»¼åˆè€ƒè™‘äº†çº¿æ€§ã€éçº¿æ€§ç»„åˆä»¥åŠæ–‡æœ¬ç±»åˆ«çš„å½±å“ï¼š")
            
            X = df_pd.drop(columns=[self.target_col])
            y = df_pd[self.target_col]
            
            # å¯¹æ–‡æœ¬åˆ—è¿›è¡Œç¼–ç  (Label Encoding)
            # LightGBM å¯ä»¥å¤„ç† Categoricalï¼Œä½†éœ€è¦è½¬ä¸º int
            cat_features_indices = []
            for i, col in enumerate(X.columns):
                if col in category_cols:
                    le = LabelEncoder()
                    # å¡«å……ç©ºæ–‡æœ¬ä¸º "Unknown" é˜²æ­¢æŠ¥é”™
                    X[col] = X[col].fillna("Unknown").astype(str)
                    X[col] = le.fit_transform(X[col])
                    cat_features_indices.append(i)
                else:
                    # æ•°å€¼åˆ—å¡«å……å‡å€¼
                    X[col] = X[col].fillna(X[col].mean())

            # å»ºç«‹æ¨¡å‹
            # max_depth=5 é™åˆ¶æ ‘æ·±ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ
            model = lgb.LGBMRegressor(random_state=42, n_estimators=200, max_depth=7, verbose=-1)
            model.fit(X, y, categorical_feature=cat_features_indices)
            
            # æå–ç‰¹å¾é‡è¦æ€§
            importances = sorted(zip(X.columns, model.feature_importances_), key=lambda x: x[1], reverse=True)
            
            # è®¡ç®—æ€»é‡è¦æ€§ç”¨äºå½’ä¸€åŒ–ç™¾åˆ†æ¯”
            total_gain = sum(model.feature_importances_)
            if total_gain == 0: total_gain = 1
            
            for name, imp in importances[:12]:
                percent = (imp / total_gain) * 100
                report.append(f"  {name}: {percent:.1f}%")

            self.progress.emit(90)

            # 5. å…³ç³»åˆ†æ 3: ç±»åˆ«åˆ†ç»„å·®å¼‚ (ANOVA æ€æƒ³)
            # çœ‹çœ‹å“ªä¸ªæ–‡æœ¬å‚æ•°ï¼ˆå¦‚å·¥ä½ã€è®¾å¤‡ï¼‰å¯¹ç»“æœå½±å“æœ€å¤§
            report.append("\n--- [ç±»åˆ«å½±å“] å“ªä¸ªæ–‡æœ¬å‚æ•°é€ æˆäº†æœ€å¤§å·®å¼‚? ---")
            best_cat = None
            max_diff = 0
            
            for col in category_cols:
                if df_pd[col].nunique() < 2 or df_pd[col].nunique() > 1000: 
                    continue # å¿½ç•¥åªæœ‰1ä¸ªå€¼æˆ–å€¼å¤ªå¤šçš„åˆ—(å¦‚ID)
                
                # è®¡ç®—ç»„é—´æ–¹å·®
                grouped = df_pd.groupby(col)[self.target_col].mean()
                diff = grouped.max() - grouped.min() # ç®€å•ç”¨æå·®è¡¨ç¤º
                
                if diff > max_diff:
                    max_diff = diff
                    best_cat = col
            
            if best_cat:
                report.append(f"  ç±»åˆ«åˆ— [{best_cat}] å¯¹ç»“æœå½±å“æœ€å¤§ï¼Œç»„é—´å‡å€¼æå·®ä¸º: {max_diff:.4f}")
                # è¿˜å¯ä»¥åˆ—å‡ºè¯¥ç±»åˆ«ä¸‹æœ€å¥½çš„å’Œæœ€å·®çš„å€¼
                grp = df_pd.groupby(best_cat)[self.target_col].mean().sort_values()
                report.append(f"    - [{best_cat}] å‡å€¼æœ€å°ç»„: {grp.index[0]} ({grp.iloc[0]:.2f})")
                report.append(f"    - [{best_cat}] å‡å€¼æœ€å¤§ç»„: {grp.index[-1]} ({grp.iloc[-1]:.2f})")

            self.progress.emit(100)
            self.finished.emit("\n".join(report))

        except Exception as e:
            import traceback
            traceback.print_exc()
            self.finished.emit(f"åˆ†æè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:\n{str(e)}")

# ==========================================
# 3. ç•Œé¢é€»è¾‘ (GUI)
# ==========================================

class ColumnWidget(QWidget):
    def __init__(self, name, dtype):
        super().__init__()
        layout = QHBoxLayout(self)
        layout.setContentsMargins(0, 2, 0, 2)
        
        self.chk = QCheckBox(name)
        self.chk.setChecked(dtype != ColumnType.IGNORE)
        
        self.combo = QComboBox()
        self.combo.addItem("æ•°å€¼", ColumnType.NUMERIC)
        self.combo.addItem("æ–‡æœ¬", ColumnType.CATEGORY)
        self.combo.addItem("å¿½ç•¥", ColumnType.IGNORE)
        
        # è®¾ç½®å½“å‰é€‰ä¸­é¡¹
        index = self.combo.findData(dtype)
        if index >= 0: self.combo.setCurrentIndex(index)
        
        layout.addWidget(self.chk, stretch=3)
        layout.addWidget(self.combo, stretch=1)
        
        # è”åŠ¨
        self.chk.stateChanged.connect(self.on_check_changed)
        self.combo.currentIndexChanged.connect(self.on_combo_changed)

    def on_check_changed(self, state):
        if state == 0: # Unchecked
            self.combo.setCurrentData(ColumnType.IGNORE)
        else:
            if self.combo.currentData() == ColumnType.IGNORE:
                self.combo.setCurrentData(ColumnType.NUMERIC) # é»˜è®¤å›æ•°å€¼ï¼Œæˆ–è€…æ ¹æ®ä¹‹å‰çŠ¶æ€

    def on_combo_changed(self, index):
        data = self.combo.currentData()
        if data == ColumnType.IGNORE:
            self.chk.setChecked(False)
        else:
            self.chk.setChecked(True)

    def get_config(self):
        return self.combo.currentData()

class PandasModel(QAbstractTableModel):
    def __init__(self, df: pl.DataFrame):
        super().__init__()
        self._df = df.head(50) # åªé¢„è§ˆå‰50è¡Œ
        self._rows = self._df.height
        self._cols = self._df.width

    def rowCount(self, parent=None): return self._rows
    def columnCount(self, parent=None): return self._cols
    def data(self, index, role=Qt.DisplayRole):
        if role == Qt.DisplayRole:
            val = self._df[index.row(), index.column()]
            return str(val) if val is not None else ""
        return None
    def headerData(self, section, orientation, role=Qt.DisplayRole):
        if role == Qt.DisplayRole and orientation == Qt.Horizontal:
            return self._df.columns[section]
        return None

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("ç”µæ± å·¥è‰ºæ•°æ®å½’å› åˆ†æç³»ç»Ÿ v2.0")
        self.resize(1200, 800)
        self.df = None
        self.col_widgets = {}
        self.setup_ui()

    def setup_ui(self):
        main = QWidget()
        self.setCentralWidget(main)
        layout = QHBoxLayout(main)

        # Left Panel
        left = QWidget()
        left.setFixedWidth(400)
        l_layout = QVBoxLayout(left)
        
        btn_load = QPushButton("1. åŠ è½½ Excel æ•°æ®")
        btn_load.clicked.connect(self.load_data)
        btn_load.setStyleSheet("height: 40px; font-weight: bold; background-color: #2b5b84; color: white;")
        l_layout.addWidget(btn_load)

        # åˆ—è®¾ç½®åŒºåŸŸ
        self.scroll = QScrollArea()
        self.scroll_content = QWidget()
        self.scroll_layout = QVBoxLayout(self.scroll_content)
        self.scroll.setWidget(self.scroll_content)
        self.scroll.setWidgetResizable(True)
        
        grp = QGroupBox("åˆ—ç±»å‹ç¡®è®¤ (è‡ªåŠ¨è¯†åˆ«)")
        g_layout = QVBoxLayout(grp)
        g_layout.addWidget(self.scroll)
        l_layout.addWidget(grp)

        # ç›®æ ‡é€‰æ‹©
        l_layout.addWidget(QLabel("é€‰æ‹©åˆ†æç›®æ ‡ (Y):"))
        self.target_combo = QComboBox()
        l_layout.addWidget(self.target_combo)

        self.btn_run = QPushButton("2. å¼€å§‹è®¡ç®—å…³è”å…³ç³»")
        self.btn_run.clicked.connect(self.run_analysis)
        self.btn_run.setEnabled(False)
        self.btn_run.setStyleSheet("height: 40px; font-weight: bold; background-color: #27ae60; color: white;")
        l_layout.addWidget(self.btn_run)

        self.pbar = QProgressBar()
        l_layout.addWidget(self.pbar)

        # Right Panel
        right = QSplitter(Qt.Vertical)
        self.table = QTableView()
        right.addWidget(self.table)
        
        self.txt = QTextEdit()
        self.txt.setReadOnly(True)
        self.txt.setStyleSheet("font-family: Consolas; font-size: 11pt; background-color: #f0f0f0;")
        right.addWidget(self.txt)
        
        layout.addWidget(left)
        layout.addWidget(right)

    def load_data(self):
        path, _ = QFileDialog.getOpenFileName(self, "é€‰æ‹©æ–‡ä»¶", "", "Excel (*.xlsx)")
        if not path: return
        
        self.txt.setText("æ­£åœ¨åŠ è½½æ•°æ®å¹¶è¿›è¡Œç±»å‹æ¨æ–­...\n")
        QApplication.processEvents()
        
        t0 = time.time()
        # è°ƒç”¨æ ¸å¿ƒå¼•æ“åŠ è½½
        self.df, types = DataEngine.load_and_convert(path)
        
        # æ¸…ç©º UI
        for i in reversed(range(self.scroll_layout.count())):
            self.scroll_layout.itemAt(i).widget().setParent(None)
        self.col_widgets.clear()
        self.target_combo.clear()
        
        # é‡å»º UI
        for col in self.df.columns:
            w = ColumnWidget(col, types[col])
            self.scroll_layout.addWidget(w)
            self.col_widgets[col] = w
            
            # åªæœ‰æ•°å€¼å‹é€‚åˆåšç›®æ ‡
            if types[col] == ColumnType.NUMERIC:
                self.target_combo.addItem(col)

        # é¢„è§ˆ
        self.table.setModel(PandasModel(self.df))
        
        self.btn_run.setEnabled(True)
        self.txt.append(f"åŠ è½½å®Œæˆ: {self.df.height} è¡Œ, {self.df.width} åˆ—\nè€—æ—¶: {time.time()-t0:.2f}s")
        self.txt.append("æç¤º: è¯·åœ¨å·¦ä¾§æ£€æŸ¥åˆ—ç±»å‹ã€‚ç³»ç»Ÿå·²è‡ªåŠ¨å°†èƒ½è½¬ä¸ºæ•°å­—çš„è½¬ä¸ºæ•°å€¼ï¼Œå¦åˆ™ä¿ç•™ä¸ºæ–‡æœ¬ã€‚")

    def run_analysis(self):
        target = self.target_combo.currentText()
        if not target: return
        
        # æ”¶é›†é…ç½®
        config = {col: w.get_config() for col, w in self.col_widgets.items()}
        
        self.btn_run.setEnabled(False)
        self.worker = AnalysisWorker(self.df, config, target)
        self.worker.progress.connect(self.pbar.setValue)
        self.worker.finished.connect(self.on_finished)
        self.worker.start()

    def on_finished(self, text):
        self.txt.append(text)
        self.btn_run.setEnabled(True)
        self.pbar.setValue(100)

if __name__ == "__main__":
    app = QApplication(sys.argv)
    win = MainWindow()
    win.show()
    sys.exit(app.exec())
```
